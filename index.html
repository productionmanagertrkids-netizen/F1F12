<!-- --- START OF FILE index.html --- -->

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Management System (Group Inside)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
        :root {
            --primary: #007bff; --success: #28a745; --info: #17a2b8; --danger: #dc3545;
            --warning: #ffc107; --dark: #343a40; --light: #f8f9fa; --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --orange: #fd7e14; --purple: #6610f2; --teal: #20c997; --pink: #e83e8c;
        }
        body { font-family: 'Kanit', sans-serif; margin: 0; background: #f0f2f5; color: #333; }
        .navbar { background: var(--dark); padding: 0 20px; display: flex; align-items: center; height: 65px; position: sticky; top: 0; z-index: 1000; }
        .nav-brand { color: white; font-weight: 600; font-size: 22px; margin-right: 30px; }
        .nav-menu { display: flex; gap: 10px; }
        .nav-link { color: #ccc; padding: 10px 20px; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        .nav-link:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-link.active { background: var(--primary); color: white; }
        .container { max-width: 1450px; margin: 20px auto; padding: 0 15px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        h2 { margin-top: 0; display: flex; align-items: center; gap: 10px; color: var(--dark); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin: 15px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border-left: 5px solid var(--primary); }
        .stat-card h3 { margin: 0; font-size: 0.9em; color: #666; }
        .stat-card .count { font-size: 2.2rem; font-weight: 600; color: var(--primary); margin: 5px 0; }
        .stat-card .sub { font-size: 0.9em; color: #777; }

        .stat-card.total { border-left-color: #6c757d; }
        .stat-card.delivered { border-left-color: var(--success); }
        .stat-card.delivered .count { color: var(--success); }
        .stat-card.pending-main { border-left-color: var(--orange); }
        .stat-card.pending-main .count { color: var(--orange); }
        .stat-card.channel { border-left-color: var(--teal); }
        .stat-card.channel .count { color: var(--teal); }

        .weight-setting-box { background: #f0f7ff; border: 1px solid #b8daff; border-radius: 10px; padding: 20px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
        .weight-item { display: flex; align-items: center; gap: 10px; font-weight: 500; }
        .weight-input { width: 60px; padding: 8px; border: 1px solid #007bff; border-radius: 6px; text-align: center; font-weight: bold; }
        
        select.form-select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; font-family: 'Kanit'; font-size: 1rem; min-width: 200px; }

        .tab-bar { display: flex; gap: 5px; overflow-x: auto; }
        .tab-item { padding: 12px 25px; background: #e9ecef; cursor: pointer; border-radius: 8px 8px 0 0; white-space: nowrap; border: 1px solid #ddd; color: #666; }
        .tab-item.active { background: white; border-bottom: 2px solid white; color: var(--primary); font-weight: 600; }

        table { width: 100%; border-collapse: collapse; background: white; font-size: 0.8em; }
        th { background: #f4f6f9; padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6; color: #333; position: sticky; top: 0; }
        td { padding: 8px 10px; border-bottom: 1px solid #eee; }
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 0.85em; font-weight: 500; }
        .bg-success-light { background: #d4edda; color: #155724; }
        .bg-warning-light { background: #fff3cd; color: #856404; }
        .bg-danger-light { background: #f8d7da; color: #721c24; }
        
        .score-box { font-weight: bold; color: var(--purple); font-size: 1.1em; }
        .text-danger { color: var(--danger); font-weight: bold; }

        .btn { border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-family: 'Kanit'; display: flex; align-items: center; gap: 8px; font-weight: 500; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-warning { background: var(--warning); color: #333; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        .channel-group { border: 1px solid #dee2e6; border-radius: 10px; margin-bottom: 15px; overflow: hidden; background: white; }
        .channel-header { background: #e2f3f5; padding: 15px 20px; display: flex; justify-content: space-between; cursor: pointer; font-weight: 600; }
        .invoice-row { border-top: 1px solid #eee; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .invoice-row:hover { background: #f8fbff; }
        .invoice-details { display: none; padding: 15px; background: #fafafa; border-top: 1px solid #eee; }
        .active-detail { display: block; }
        .status-tag { display: inline-flex; align-items: center; background: #e9ecef; padding: 5px 12px; border-radius: 20px; font-size: 0.85em; margin: 5px 5px 0 0; }
        .status-tag span { cursor: pointer; margin-left: 8px; color: var(--danger); font-weight: bold; }

        /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Group ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô List */
        .cat-group-header {
            color: #d63384; /* ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏Ç‡πâ‡∏°/‡πÅ‡∏î‡∏á */
            font-weight: 600;
            font-size: 0.95em;
            margin-top: 10px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .cat-group-header:first-child { margin-top: 0; }
        .cat-badge {
            background-color: #d63384;
            color: white;
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        .item-row {
            padding-left: 15px;
            margin-bottom: 4px;
            color: #444;
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-brand">üè≠ Production System</div>
        <div class="nav-menu">
            <div class="nav-link active" onclick="showPage('dash', this)">1. Dashboard ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</div>
            <div class="nav-link" onclick="showPage('kpi', this)">2. KPI ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</div>
        </div>
    </nav>

    <div class="container">
        <!-- PAGE 1: DASHBOARD -->
        <div id="page-dash" class="page active">
            <div class="card">
                <h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå (Dashboard)</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á:</label>
                        <div style="display: flex; gap: 5px; margin-top:5px;">
                            <input type="text" id="status-input" style="flex:1; padding:8px; border-radius:8px; border:1px solid #ddd;" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏™‡πà‡∏á‡∏ä‡πà‡∏≤‡∏á...">
                            <button class="btn btn-success" onclick="addStatusTag()">+</button>
                        </div>
                        <div id="status-tags-area"></div>
                    </div>
                    <div>
                        <label>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel Dashboard (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå):</label>
                        <div style="margin-top:5px;">
                            <input type="file" id="dash-upload" accept=".xlsx, .xls" multiple hidden>
                            <button class="btn btn-primary" onclick="document.getElementById('dash-upload').click()">üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</button>
                            <div id="dash-file-info" style="font-size: 0.8em; color: #666; margin-top:5px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="dash-result-area" style="display: none;">
                <div id="capture-zone-dash" style="background: #f0f2f5; padding: 20px; border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏¥‡∏ï</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-info" onclick="exportDashboardPNG()">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û</button>
                            <button class="btn btn-warning" onclick="copyFullSummary()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ</button>
                        </div>
                    </div>
                    
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å -->
                    <div id="dash-main-summary" class="dashboard-grid"></div>

                    <!-- ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á -->
                    <h2 style="margin-top: 30px;">üõí ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á (‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á):</h2>
                    <div id="dash-channel-cards" class="dashboard-grid"></div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
                    <h2 style="margin-top: 30px;">üîç ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</h2>
                    <div id="dash-status-cards" class="dashboard-grid"></div>
                </div>

                <div style="margin-top: 40px; border-top: 2px solid #ddd; padding-top: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏¥‡∏ï (Grouped)</h2>
                        <button class="btn btn-danger" onclick="clearAllDashStatuses()">‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                    <div id="dash-list-container" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <!-- PAGE 2: KPI -->
        <div id="page-kpi" class="page">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>‚è±Ô∏è ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì KPI ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á</h2>
                    <div style="display: flex; gap: 10px;">
                        <input type="file" id="kpi-upload" accept=".xlsx, .xls" multiple hidden>
                        <button class="btn btn-primary" onclick="document.getElementById('kpi-upload').click()">üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå KPI</button>
                    </div>
                </div>
                <div id="kpi-file-info" style="font-size: 0.85em; color: #666; margin-top:5px;"></div>
            </div>

            <div id="kpi-result-area" style="display: none;">
                <div class="weight-setting-box">
                    <strong>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤:</strong>
                    <div class="weight-item">‡∏ï‡∏£‡∏á‡πÅ‡∏ú‡∏ô: <input type="number" id="w-ontime" class="weight-input" value="70" onchange="recalculateKPI()"> %</div>
                    <div class="weight-item">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß: <input type="number" id="w-eff" class="weight-input" value="30" onchange="recalculateKPI()"> %</div>
                    <div class="weight-item" style="border-left: 2px solid #ddd; padding-left: 20px;">
                        üîç ‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô: 
                        <select id="kpi-job-filter" class="form-select" onchange="recalculateKPI()">
                            <option value="ALL">-- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                        </select>
                    </div>
                    <div style="margin-left: auto; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="exportKPIToExcel()">üìä Export Excel</button>
                        <button class="btn btn-warning" onclick="copyAllDeptsSummary()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ</button>
                    </div>
                </div>

                <div class="tab-bar" id="kpi-tab-bar"></div>
                <div id="capture-zone-kpi" class="card" style="border-radius: 0 12px 12px 12px; border-top:none; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 id="dept-title-png" style="margin:0; color:var(--primary);">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÅ‡∏ú‡∏ô‡∏Å</h4>
                        <button class="btn btn-info btn-sm" onclick="exportKPIPNG()">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û</button>
                    </div>
                    <div id="kpi-summary-cards" class="dashboard-grid"></div>
                    <div style="overflow-x: auto; margin-top: 15px;">
                        <table id="kpi-table">
                            <thead>
                                <tr>
                                    <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th>‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</th>
                                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    <th>‡πÅ‡∏ú‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
                                    <th>‡πÅ‡∏ú‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à</th>
                                    <th>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏£‡∏¥‡∏á</th>
                                    <th>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á</th>
                                    <th>‡πÄ‡∏ß‡∏•‡∏≤ (‡∏à‡∏£‡∏¥‡∏á/‡πÅ‡∏ú‡∏ô)</th>
                                    <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡∏¥‡∏ô</th>
                                    <th>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤</th>
                                    <th>‡∏ï‡∏£‡∏á‡πÅ‡∏ú‡∏ô (%)</th>
                                    <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß (%)</th>
                                    <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>
                                </tr>
                            </thead>
                            <tbody id="kpi-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Helper Functions ---
        function showPage(pageId, el) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
        }
        const getVal = (row, names) => {
            for (let n of names) {
                let key = Object.keys(row).find(k => k.trim().toLowerCase() === n.toLowerCase());
                if (key !== undefined) return row[key];
            }
            return '';
        };
        const getItemWeight = (name) => (name && String(name).includes('‡∏ï‡∏£‡∏≤‡∏¢‡∏≤‡∏á‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î')) ? 0.2 : 1;

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    resolve(workbook);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // ==========================================
        //  PAGE 1: DASHBOARD LOGIC
        // ==========================================
        let fullExcelData = [];
        let pendingData = [];
        let customStatuses = JSON.parse(localStorage.getItem('prodStatuses') || '["‡∏£‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°", "‡∏£‡∏≠‡∏ú‡∏•‡∏¥‡∏ï", "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï"]');

        document.getElementById('dash-upload').onchange = async (e) => {
            const files = e.target.files;
            if (!files.length) return;
            
            document.getElementById('dash-file-info').textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î ${files.length} ‡πÑ‡∏ü‡∏•‡πå...`;
            fullExcelData = []; 

            for (let i = 0; i < files.length; i++) {
                const wb = await readExcelFile(files[i]);
                const sheetData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                fullExcelData = fullExcelData.concat(sheetData);
            }

            document.getElementById('dash-file-info').textContent = `‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (${files.length} ‡πÑ‡∏ü‡∏•‡πå, ${fullExcelData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
            pendingData = fullExcelData.filter(r => !String(getVal(r, ['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'Status'])).includes('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß'));
            document.getElementById('dash-result-area').style.display = 'block';
            renderDashboard();
        };

        function renderDashboard() {
            // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
            const totalBills = new Set(fullExcelData.map(r => getVal(r, ['‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', 'Order ID']))).size;
            let totalItems = 0; fullExcelData.forEach(r => totalItems += getItemWeight(getVal(r, ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'Product'])));
            const deliveredRows = fullExcelData.filter(r => String(getVal(r, ['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'Status'])).includes('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß'));
            const deliveredBills = new Set(deliveredRows.map(r => getVal(r, ['‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', 'Order ID']))).size;
            let deliveredItems = 0; deliveredRows.forEach(r => deliveredItems += getItemWeight(getVal(r, ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'Product'])));
            const pendingBills = new Set(pendingData.map(r => getVal(r, ['‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', 'Order ID']))).size;
            let pendingItems = 0; pendingData.forEach(r => pendingItems += getItemWeight(getVal(r, ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'Product'])));

            document.getElementById('dash-main-summary').innerHTML = `
                <div class="stat-card total"><h3>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><div class="count">${totalBills}<span class="unit"> ‡∏ö‡∏¥‡∏•</span></div><div class="sub">${Math.ceil(totalItems)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
                <div class="stat-card delivered"><h3>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</h3><div class="count">${deliveredBills}<span class="unit"> ‡∏ö‡∏¥‡∏•</span></div><div class="sub">${Math.ceil(deliveredItems)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
                <div class="stat-card pending-main"><h3>‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏¥‡∏ï</h3><div class="count">${pendingBills}<span class="unit"> ‡∏ö‡∏¥‡∏•</span></div><div class="sub">${Math.ceil(pendingItems)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
            `;

            // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á (Channel)
            const channelStats = {};
            pendingData.forEach(r => {
                const id = String(getVal(r, ['‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', 'Order ID']));
                const chan = (id.match(/^[A-Za-z]+/) || ['OTHER'])[0].toUpperCase();
                
                if (!channelStats[chan]) channelStats[chan] = { bills: new Set(), items: 0 };
                channelStats[chan].bills.add(id);
                channelStats[chan].items += getItemWeight(getVal(r, ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'Product']));
            });

            document.getElementById('dash-channel-cards').innerHTML = Object.entries(channelStats).map(([chan, d]) => `
                <div class="stat-card channel">
                    <h3>${chan} (‡∏Ñ‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏¥‡∏ï)</h3>
                    <div class="count">${d.bills.size}<span class="unit"> ‡∏ö‡∏¥‡∏•</span></div>
                    <div class="sub">${Math.ceil(d.items)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
            `).join('');

            // ‚ùå ‡∏™‡πà‡∏ß‡∏ô Category Card ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠

            // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status Tags)
            const statusStats = {};
            pendingData.forEach(r => {
                const id = getVal(r, ['‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', 'Order ID']);
                const s = localStorage.getItem(`dash-s-${id}`) || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏';
                if (!statusStats[s]) statusStats[s] = { bills: new Set(), items: 0 };
                statusStats[s].bills.add(id);
                statusStats[s].items += getItemWeight(getVal(r, ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'Product']));
            });
            document.getElementById('dash-status-cards').innerHTML = Object.entries(statusStats).map(([s, d]) => `
                <div class="stat-card" style="border-left-color: ${s==='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏'?'#ccc':'var(--info)'}">
                    <h3>${s}</h3><div class="count">${d.bills.size}<span class="unit"> ‡∏ö‡∏¥‡∏•</span></div><div class="sub">${Math.ceil(d.items)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
            `).join('');
            
            renderBillList();
        }

        function renderBillList() {
            const grouped = pendingData.reduce((acc, r) => {
                const id = String(getVal(r, ['‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•', 'Order ID']));
                const chan = (id.match(/^[A-Za-z]+/) || ['OTHER'])[0].toUpperCase();
                if (!acc[chan]) acc[chan] = {};
                if (!acc[chan][id]) acc[chan][id] = [];
                acc[chan][id].push(r);
                return acc;
            }, {});
            const listCont = document.getElementById('dash-list-container');
            listCont.innerHTML = '';
            
            for (let chan in grouped) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'channel-group';
                groupDiv.innerHTML = `<div class="channel-header" onclick="this.nextElementSibling.style.display = (this.nextElementSibling.style.display==='none'?'block':'none')">${chan} <span>${Object.keys(grouped[chan]).length} ‡∏ö‡∏¥‡∏• ‚ñº</span></div><div class="channel-body" style="display:block;"></div>`;
                const body = groupDiv.querySelector('.channel-body');
                
                for (let billId in grouped[chan]) {
                    const items = grouped[chan][billId];
                    const saved = localStorage.getItem(`dash-s-${billId}`) || '';
                    
                    // üü¢ GROUP ITEMS BY CATEGORY INSIDE BILL
                    const itemsByCat = {};
                    const categoriesSet = new Set();
                    
                    items.forEach(i => {
                        let cat = getVal(i, ['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'Category', 'Group']) || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Other)';
                        categoriesSet.add(cat);
                        if (!itemsByCat[cat]) itemsByCat[cat] = [];
                        itemsByCat[cat].push(i);
                    });
                    
                    const catTags = [...categoriesSet].join(', '); // For display next to Bill ID

                    let innerDetailsHtml = '';
                    // Loop ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Group
                    for (const [catName, catItems] of Object.entries(itemsByCat)) {
                        innerDetailsHtml += `<div class="cat-group-header">üìÅ ${catName} <span class="cat-badge">${catItems.length}</span></div>`;
                        catItems.forEach(i => {
                            innerDetailsHtml += `<div class="item-row">‚Ä¢ ${getVal(i, ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'Product'])} <small style="color:#666">(${getVal(i, ['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'Description'])})</small></div>`;
                        });
                    }

                    const row = document.createElement('div');
                    row.innerHTML = `
                        <div class="invoice-row" onclick="this.nextElementSibling.classList.toggle('active-detail')">
                            <div style="flex:1">
                                <strong>${billId}</strong> 
                                ${catTags ? `<small style="background:#f0f0f0; padding:2px 6px; border-radius:4px; margin-left:10px; color:#888;">${catTags}</small>` : ''}
                            </div>
                            <select onchange="updateBillStatus('${billId}', this.value)" onclick="event.stopPropagation()">
                                <option value="">-- ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>${customStatuses.map(s => `<option value="${s}" ${s===saved?'selected':''}>${s}</option>`).join('')}
                            </select>
                        </div>
                        <div class="invoice-details">
                            ${innerDetailsHtml}
                        </div>`;
                    body.appendChild(row);
                }
                listCont.appendChild(groupDiv);
            }
        }

        window.exportDashboardPNG = () => {
            html2canvas(document.getElementById('capture-zone-dash'), { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏¥‡∏ï-${new Date().toLocaleDateString('th-TH')}.png`;
                link.href = canvas.toDataURL(); link.click();
            });
        };

        window.copyFullSummary = () => {
            let text = `üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleDateString('th-TH')}\n`;
            
            // 1. ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
            document.querySelectorAll('#dash-main-summary .stat-card').forEach(c => text += `${c.querySelector('h3').innerText}: ${c.querySelector('.count').innerText} (${c.querySelector('.sub').innerText})\n`);
            
            // 2. ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á
            text += `\nüõí ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á (‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á):\n`;
            document.querySelectorAll('#dash-channel-cards .stat-card').forEach(c => {
                let chanName = c.querySelector('h3').innerText.replace(' (‡∏Ñ‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏¥‡∏ï)', '');
                let bills = c.querySelector('.count').innerText;
                let items = c.querySelector('.sub').innerText;
                text += `- ${chanName}: ${bills} (${items})\n`;
            });

            // 3. ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß)
            text += `\nüóÇÔ∏è ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:\n`;
            const catSummary = {};
            pendingData.forEach(r => {
                let cat = getVal(r, ['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'Category', 'Group']) || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if(!catSummary[cat]) catSummary[cat] = 0;
                catSummary[cat]++;
            });
            Object.entries(catSummary).forEach(([cat, count]) => {
                 text += `- ${cat}: ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`;
            });

            // 4. ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            text += `\nüìç ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:\n`;
            document.querySelectorAll('#dash-status-cards .stat-card').forEach(c => text += `- ${c.querySelector('h3').innerText}: ${c.querySelector('.count').innerText} (${c.querySelector('.sub').innerText})\n`);
            
            navigator.clipboard.writeText(text).then(() => alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!'));
        };

        window.updateBillStatus = (id, val) => { val ? localStorage.setItem(`dash-s-${id}`, val) : localStorage.removeItem(`dash-s-${id}`); renderDashboard(); };
        window.clearAllDashStatuses = () => { if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) { Object.keys(localStorage).forEach(k => k.startsWith('dash-s-') && localStorage.removeItem(k)); renderDashboard(); }};
        function addStatusTag() { const v = document.getElementById('status-input').value.trim(); if(v && !customStatuses.includes(v)) { customStatuses.push(v); localStorage.setItem('prodStatuses', JSON.stringify(customStatuses)); document.getElementById('status-input').value=''; renderStatusTags(); } }
        function renderStatusTags() { document.getElementById('status-tags-area').innerHTML = customStatuses.map(s => `<div class="status-tag">${s} <span onclick="removeStatusTag('${s}')">&times;</span></div>`).join(''); }
        function removeStatusTag(s) { customStatuses = customStatuses.filter(x => x !== s); localStorage.setItem('prodStatuses', JSON.stringify(customStatuses)); renderStatusTags(); }
        renderStatusTags();

        // ==========================================
        //  PAGE 2: KPI LOGIC
        // ==========================================
        let kpiAllDepts = {};
        let activeDept = "";

        document.getElementById('kpi-upload').onchange = async (e) => {
            const files = e.target.files;
            if (!files.length) return;
            
            document.getElementById('kpi-file-info').textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${files.length} ‡πÑ‡∏ü‡∏•‡πå...`;
            kpiAllDepts = {}; 

            for (let i = 0; i < files.length; i++) {
                const wb = await readExcelFile(files[i]);
                wb.SheetNames.forEach(name => {
                    const data = XLSX.utils.sheet_to_json(wb.Sheets[name], { raw: true });
                    if(data.length > 0) {
                        if(kpiAllDepts[name]) {
                            kpiAllDepts[name] = kpiAllDepts[name].concat(data);
                        } else {
                            kpiAllDepts[name] = data;
                        }
                    }
                });
            }

            document.getElementById('kpi-file-info').textContent = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${Object.keys(kpiAllDepts).length} ‡πÅ‡∏ú‡∏ô‡∏Å ‡∏à‡∏≤‡∏Å ${files.length} ‡πÑ‡∏ü‡∏•‡πå`;
            activeDept = Object.keys(kpiAllDepts)[0] || "";
            document.getElementById('kpi-result-area').style.display = 'block';
            
            renderKPITabs();
            updateJobFilterDropdown();
            recalculateKPI();
        };

        function parseTime(val) {
            if (!val) return null;
            let d = new Date();
            if (typeof val === 'number') {
                const totalSec = Math.round(val * 86400);
                d.setHours(Math.floor(totalSec/3600), Math.floor((totalSec%3600)/60), 0, 0);
                return d;
            }
            if (typeof val === 'string' && val.includes(':')) {
                const [h, m] = val.split(':').map(Number);
                d.setHours(h, m, 0, 0); return d;
            }
            return (val instanceof Date) ? val : null;
        }

        function fmtTime(d) { return d ? d.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}) + ' ‡∏ô.' : '-'; }

        function renderKPITabs() {
            const bar = document.getElementById('kpi-tab-bar');
            bar.innerHTML = Object.keys(kpiAllDepts).map(name => `<div class="tab-item ${name===activeDept?'active':''}" onclick="changeDept('${name}')">${name}</div>`).join('');
        }
        
        function changeDept(name) { 
            activeDept = name; 
            renderKPITabs(); 
            updateJobFilterDropdown(); 
            recalculateKPI(); 
        }

        function updateJobFilterDropdown() {
            if (!activeDept || !kpiAllDepts[activeDept]) return;
            const data = kpiAllDepts[activeDept];
            const select = document.getElementById('kpi-job-filter');
            
            const jobs = new Set();
            data.forEach(r => {
                const name = getVal(r, ['‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏á‡∏≤‡∏ô', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']);
                if(name) jobs.add(name);
            });

            select.innerHTML = '<option value="ALL">-- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>';
            jobs.forEach(job => {
                const opt = document.createElement('option');
                opt.value = job;
                opt.innerText = job;
                select.appendChild(opt);
            });
        }

        function getKPIRowData(row) {
            const pStart = parseTime(getVal(row, ['‡πÅ‡∏ú‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°', '‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏±‡∏î']));
            const pEnd = parseTime(getVal(row, ['‡πÅ‡∏ú‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à']));
            const aStart = parseTime(getVal(row, ['‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏£‡∏¥‡∏á']));
            const aEnd = parseTime(getVal(row, ['‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á']));
            if(!aEnd || !pStart || !pEnd || !aStart) return null;
            const pDuration = Math.max(1, Math.round((pEnd - pStart) / 60000));
            const aDuration = Math.max(1, Math.round((aEnd - aStart) / 60000));
            const delayMin = Math.round((aEnd - pEnd) / 60000);
            const timeExceeded = Math.max(0, aDuration - pDuration);
            let scoreOnTime = (delayMin <= 0) ? 100 : Math.round((pDuration / (pDuration + delayMin)) * 100);
            let scoreEff = Math.min(100, Math.round((pDuration / aDuration) * 100));
            return { pStart, pEnd, aStart, aEnd, pDuration, aDuration, delayMin, timeExceeded, scoreOnTime, scoreEff };
        }

        function recalculateKPI() {
            if(!activeDept) return;
            const data = kpiAllDepts[activeDept];
            const wOnTimeWeight = parseFloat(document.getElementById('w-ontime').value) / 100;
            const wEffWeight = parseFloat(document.getElementById('w-eff').value) / 100;
            const filterJob = document.getElementById('kpi-job-filter').value;

            document.getElementById('dept-title-png').innerText = `‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÅ‡∏ú‡∏ô‡∏Å: ${activeDept} ${filterJob !== 'ALL' ? '(‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ö‡∏á‡∏≤‡∏ô: ' + filterJob + ')' : ''}`;
            
            let totalWeighted = 0, totalOnTime = 0, totalEff = 0, count = 0;
            const tbody = document.getElementById('kpi-table-body');
            tbody.innerHTML = "";
            
            data.forEach((row, idx) => {
                const jobName = getVal(row, ['‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏á‡∏≤‡∏ô', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']);
                if (filterJob !== 'ALL' && jobName !== filterJob) return;

                const res = getKPIRowData(row);
                if(!res) return;
                
                const finalScore = Math.round((res.scoreOnTime * wOnTimeWeight) + (res.scoreEff * wEffWeight));
                totalWeighted += finalScore; totalOnTime += res.scoreOnTime; totalEff += res.scoreEff; count++;
                
                const qty = getVal(row, ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', 'Qty', 'Quantity']) || '-';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${count}</td>
                    <td><strong>${jobName}</strong></td>
                    <td>${qty}</td>
                    <td>${fmtTime(res.pStart)}</td>
                    <td>${fmtTime(res.pEnd)}</td>
                    <td>${fmtTime(res.aStart)}</td>
                    <td>${fmtTime(res.aEnd)}</td>
                    <td>${res.aDuration} / ${res.pDuration} ‡∏ô.</td>
                    <td class="${res.timeExceeded > 0 ? 'text-danger' : ''}">${res.timeExceeded > 0 ? res.timeExceeded + ' ‡∏ô.' : '0'}</td>
                    <td class="${res.delayMin > 0 ? 'text-danger' : ''}">${res.delayMin > 0 ? res.delayMin + ' ‡∏ô.' : '0'}</td>
                    <td><span class="badge ${res.scoreOnTime >= 80 ? 'bg-success-light' : (res.scoreOnTime >= 50 ? 'bg-warning-light' : 'bg-danger-light')}">${res.scoreOnTime}%</span></td>
                    <td><span class="badge bg-success-light">${res.scoreEff}%</span></td>
                    <td class="score-box">${finalScore}</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('kpi-summary-cards').innerHTML = `
                <div class="stat-card" style="border-left-color: var(--purple);"><h3>KPI ‡∏£‡∏ß‡∏°‡πÅ‡∏ú‡∏ô‡∏Å</h3><div class="count">${count > 0 ? Math.round(totalWeighted/count) : 0}</div><div class="sub">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏à‡∏≤‡∏Å ${count} ‡∏á‡∏≤‡∏ô</div></div>
                <div class="stat-card" style="border-left-color: var(--success);"><h3>‡∏ú‡∏•‡∏™‡∏£‡∏∏‡∏õ: ‡∏ï‡∏£‡∏á‡πÅ‡∏ú‡∏ô</h3><div class="count">${count > 0 ? Math.round(totalOnTime/count) : 0}%</div><div class="sub">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</div></div>
                <div class="stat-card" style="border-left-color: var(--info);"><h3>‡∏ú‡∏•‡∏™‡∏£‡∏∏‡∏õ: ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß</h3><div class="count">${count > 0 ? Math.round(totalEff/count) : 0}%</div><div class="sub">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</div></div>
            `;
        }

        window.exportKPIPNG = () => {
            html2canvas(document.getElementById('capture-zone-kpi'), { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `KPI-‡∏™‡∏£‡∏∏‡∏õ-${activeDept}-${new Date().toLocaleDateString('th-TH')}.png`;
                link.href = canvas.toDataURL(); link.click();
            });
        };

        window.exportKPIToExcel = () => {
            const wb = XLSX.utils.book_new();
            const wOnTimeWeight = parseFloat(document.getElementById('w-ontime').value) / 100;
            const wEffWeight = parseFloat(document.getElementById('w-eff').value) / 100;
            const filterJob = document.getElementById('kpi-job-filter').value; 

            const overallSummary = [];

            const deptsSheets = [];
            for (let deptName in kpiAllDepts) {
                const sheetData = [];
                let totalWeighted = 0, totalOnTime = 0, totalEff = 0, count = 0;

                kpiAllDepts[deptName].forEach((row, idx) => {
                    if (deptName === activeDept && filterJob !== 'ALL' && getVal(row, ['‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏á‡∏≤‡∏ô', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']) !== filterJob) return;

                    const res = getKPIRowData(row);
                    if(!res) return;
                    const finalScore = Math.round((res.scoreOnTime * wOnTimeWeight) + (res.scoreEff * wEffWeight));
                    totalWeighted += finalScore; totalOnTime += res.scoreOnTime; totalEff += res.scoreEff; count++;

                    sheetData.push({
                        "‡∏•‡∏≥‡∏î‡∏±‡∏ö": count, "‡πÉ‡∏ö‡∏á‡∏≤‡∏ô": getVal(row, ['‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏á‡∏≤‡∏ô', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']),
                        "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": getVal(row, ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', 'Qty', 'Quantity']),
                        "‡πÅ‡∏ú‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°": fmtTime(res.pStart), "‡πÅ‡∏ú‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à": fmtTime(res.pEnd),
                        "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏£‡∏¥‡∏á": fmtTime(res.aStart), "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á": fmtTime(res.aEnd),
                        "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏à‡∏£‡∏¥‡∏á": res.aDuration, "‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô": res.pDuration,
                        "‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡∏¥‡∏ô": res.timeExceeded, "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤": res.delayMin,
                        "‡∏ï‡∏£‡∏á‡πÅ‡∏ú‡∏ô(%)": res.scoreOnTime, "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß(%)": res.scoreEff, "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°": finalScore
                    });
                });

                if(count > 0) {
                    const avgW = Math.round(totalWeighted/count);
                    const avgOT = Math.round(totalOnTime/count);
                    const avgEF = Math.round(totalEff/count);

                    sheetData.push({});
                    sheetData.push({ "‡πÉ‡∏ö‡∏á‡∏≤‡∏ô": "‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°", "‡∏ï‡∏£‡∏á‡πÅ‡∏ú‡∏ô(%)": avgOT, "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß(%)": avgEF, "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°": avgW });
                    overallSummary.push({ "‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å": deptName, "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô": count, "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢": avgW, "‡∏ï‡∏£‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢(%)": avgOT, "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢(%)": avgEF });
                    deptsSheets.push({ name: deptName, data: sheetData });
                }
            }

            const wsSum = XLSX.utils.json_to_sheet(overallSummary);
            XLSX.utils.book_append_sheet(wb, wsSum, "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°");
            deptsSheets.forEach(dept => {
                const ws = XLSX.utils.json_to_sheet(dept.data);
                XLSX.utils.book_append_sheet(wb, ws, dept.name);
            });
            XLSX.writeFile(wb, `‡∏™‡∏£‡∏∏‡∏õKPI_${filterJob !== 'ALL' ? 'Filtered' : 'All'}_${new Date().toLocaleDateString('th-TH')}.xlsx`);
        };

        window.copyAllDeptsSummary = () => {
            const wOnTimeWeight = parseFloat(document.getElementById('w-ontime').value) / 100;
            const wEffWeight = parseFloat(document.getElementById('w-eff').value) / 100;
            let summaryText = `üìä ‡∏™‡∏£‡∏∏‡∏õ KPI ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å\nüìÖ ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleDateString('th-TH')}\n`;
            summaryText += `--------------------------\n`;
            for (let deptName in kpiAllDepts) {
                let totalWeighted = 0, totalOnTime = 0, totalEff = 0, count = 0;
                kpiAllDepts[deptName].forEach(row => {
                    const res = getKPIRowData(row);
                    if(!res) return;
                    totalWeighted += Math.round((res.scoreOnTime * wOnTimeWeight) + (res.scoreEff * wEffWeight));
                    totalOnTime += res.scoreOnTime; totalEff += res.scoreEff; count++;
                });
                if(count > 0) {
                    summaryText += `üìç ‡πÅ‡∏ú‡∏ô‡∏Å: ${deptName}\nüîπ KPI ‡∏£‡∏ß‡∏°: ${Math.round(totalWeighted/count)} ‡πÅ‡∏ï‡πâ‡∏°\n‚úÖ ‡∏ï‡∏£‡∏á‡πÅ‡∏ú‡∏ô: ${Math.round(totalOnTime/count)}%\n‚ö°Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß: ${Math.round(totalEff/count)}%\nüì¶ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à: ${count} ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô\n--------------------------\n`;
                }
            }
            navigator.clipboard.writeText(summaryText).then(() => alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!'));
        };
    </script>
</body>
</html>
